<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Spaccamuro</title>
    <meta name="description" content="Appoggia il telefono, batti un colpo sul tavolo e butta giù il muro">
    <meta property="og:description" content="Appoggia il telefono, batti un colpo sul tavolo e butta giù il muro">
    <meta property="og:title" content="Spaccamuro">
    <meta property="og:url" content="https://www.spaccamuro.it/">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://www.spaccamuro.it/img/screenshot.png">
    <link rel="icon" href="img/favicon.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#900">
    <link rel="apple-touch-icon" href="/img/icon-192.png">
    <link rel="stylesheet" href="style.css?e">
    <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "SoftwareApplication",
          "name": "Spaccamuro",
          "author": {
            "@type": "Person",
            "givenName": "Nello",
            "familyName": "Polesello",
            "email": "polesello@infofactory.it",
            "jobTitle": "Sviluppatore web"
          },
          "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
          },
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "5",
            "reviewCount": "1"
          },    
          "applicationCategory": "GameApplication",
          "operatingSystem": "Android",
          "screenshot": "https://wwww.spaccamuro.it/img/screenshot.png",
          "softwareVersion": "1.0",
          "abstract": "Gioco per smartphone che sfrutta l’evento devicemotion permettendo di battere sul tavolo per distruggere il muro",
          "accessMode": ["tactile", "visual"],
          "dateCreated": "2022-02-08"
        }
        </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1DTBZ8VK97"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1DTBZ8VK97');
</script>
   
    <script>
        if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(function(
            registration) {
            console.log('Registration successful, scope is:',
                registration.scope)
        }).catch(function(error) {
            console.log(
                'Service worker registration failed, error:',
                error);
        })
    }
    </script>
</head>
<body>
    <div id="wrapper">
    <div class="buttons">
        <button id="player1"></button>
        <button id="player2"></button>
    </div>

    <div class="title">
        <h1><img src="img/logo.png" alt="Spaccamuro"></h1>
        <div class="external">
            <!-- <a href="https://figherie.it/app/spaccamuro/">ⓘ</a> -->
            <form action="https://www.paypal.com/donate" method="post" target="_top">
                <input type="hidden" name="hosted_button_id" value="8ELNZTS7H2ACE">
                <input type="submit" value="€">
            </form>
        </div>
    </div>

    <button class="stop fadeout">↺</button>

    <div id="page1">
<div class="muro">
    <div class="fila" style="z-index: 5;">
        <div class="mattone caduto"></div>
    </div>
    <div class="fila" style="z-index: 4;">
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
    </div>
    <div class="fila" style="z-index: 3;">
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
    </div>
    <div class="fila" style="z-index: 2;">
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
    </div>
    <div class="fila" style="z-index: 1;">
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
        <div class="mattone caduto"></div>
    </div>
</div>
    <div class="prato">

        <div class="istruzioni">
            <p>Se vuoi fare pratica, appoggia il telefono sul tavolo, batti un colpo e butta giù il muro.</p>
            <p>Più forte batti, più mattoni butti giù!</p>
        </div>
        <div class="istruzioni">
            <p>Se sei in due, quando è il tuo turno devi buttare giù il numero di mattoni indicato.</p>
            <p>Se ne butti giù di più, verrà ricostruito il muro per il numero di mattoni in eccesso.</p>
            <p>Il primo che fa cadere il muro vince.</p>

        </div>
    </div>
</div> <!-- page1 -->


<audio id="audio-down" src="down.mp3"></audio>
<audio id="audio-up" src="up.mp3"></audio>
<audio id="audio-siren" src="siren.mp3"></audio>




<div id="page2">

    <div class="muro player1">
        <div class="fila" style="z-index: 5;">
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 4;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 3;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 2;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 1;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
    </div>
    <div class="target"></div>

    <div class="prato"></div>

    <div class="muro player2">
        <div class="fila" style="z-index: 5;">
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 4;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 3;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 2;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
        <div class="fila" style="z-index: 1;">
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
            <div class="mattone caduto"></div>
        </div>
    </div>
    <div class="target"></div>

</div>
    </div>




<script>

    let wakeLockObj = null
    const audioDown = document.getElementById('audio-down')
    const audioUp = document.getElementById('audio-up')
    let players = 1
    let player = 1
    let muro = document.querySelector('#page1 .muro')
    let mattoni = muro.querySelectorAll('.mattone')
    let mattoniCaduti = muro.querySelectorAll('.mattone.caduto')
    let mattoniDaButtare = mattoni.length - mattoniCaduti.length
    let target = 1
    let cambioInCorso = null
    let mattoniButtati = 0


    function noStandby() {
        if ("wakeLock" in navigator && wakeLockObj === null) {
            navigator.wakeLock.request("screen").then(function(wakeLock) {
                wakeLockObj = wakeLock;
            }).catch(function(err) {
                console.error(`${err.name}, ${err.message}`);
            });
        }
    }
     
     
    document.getElementById('player1').addEventListener('click', function() {
        document.getElementById('page1').style.display = 'block'
        document.getElementById('page2').style.display = 'none'
        document.querySelector('#page1 .muro').style.display = 'block'
        players = 1
        setTimeout(buttaSu, 1000)
    })

    document.getElementById('player2').addEventListener('click', function() {
        document.getElementById('page1').style.display = 'none'
        document.getElementById('page2').style.display = 'block'
        players = 2
        setTimeout(buttaSu, 1000)
    })

    document.querySelector('.stop').addEventListener('click', function() {
        players = 1
        finePartita()
    })
    
    function handleMotionEvent(event) {
        const z = event.accelerationIncludingGravity.z
        if (Math.abs(z) > 11) { // abs perché iOs è negativa, Android è positiva
            buttaGiu()
        }
    }
    
    // in iOS va richiesto il permesso
    let permissionGranted = false
    
    function getPermission () {
        if (!permissionGranted) {
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response == "granted") {
                        window.addEventListener("devicemotion", handleMotionEvent, true)
                    }
            })
        }
    }
    
    // iPhone
    if (typeof(DeviceMotionEvent) !== "undefined" && typeof(DeviceMotionEvent.requestPermission) === "function") {
        document.getElementById('player1').addEventListener('click', getPermission)
        document.getElementById('player2').addEventListener('click', getPermission)
    } else {
        // Android
        window.addEventListener("devicemotion", handleMotionEvent, true)
    }
    



    
    function cambiaGiocatore() {
        // Se ne ha buttati giù più di quanto richiesto, gli ricostruisco tanti mattoni quanti ne ha buttati giù in più
        const inPiu = mattoniButtati - target
        cambioInCorso = null
   
        if (inPiu > 0) {
            for (let i = 0; i < inPiu + mattoniButtati; i++) {
                const mattoniCaduti = muro.querySelectorAll('.mattone.caduto')
                if (mattoniCaduti.length) {
                    mattoniCaduti[mattoniCaduti.length - 1].classList.remove('caduto')
                    audioUp.play()
                }
            }
        }


        player = player == 1 ? 2 : 1
        mattoniButtati = 0
        muro = document.querySelector('.muro.player' + player)
        document.querySelectorAll('.muro').forEach(el => el.classList.remove('active'))
        muro.classList.add('active')
        mattoni = muro.querySelectorAll('.mattone')
        mattoniCaduti = muro.querySelectorAll('.mattone.caduto')
        mattoniDaButtare = mattoni.length - mattoniCaduti.length
        target = calculateTarget()
        muro.nextElementSibling.textContent = target
    }
    
    function buttaGiu() {
        mattoniDaButtare = muro.querySelectorAll('.mattone:not(.caduto)').length

        if (mattoniDaButtare > 0) {
            mattoni[mattoni.length - mattoniDaButtare].classList.add('caduto')
            audioDown.play()
            mattoniButtati++
            mattoniDaButtare--
        }

        // cambio giocatore (un secondo è il tempo per buttare giù uno o più mattoni)
        // se è in due e non è già in corso un cambio e non ha buttato giù tutti i mattoni
        // oppure li ha buttati giù tutti ma ne ha buttati giù più di quanti richiesti
        if (players == 2 && !cambioInCorso && (mattoniDaButtare > 0 || mattoniButtati > target)) {
            cambioInCorso = setTimeout(cambiaGiocatore, 1000)
        }

        if (mattoniDaButtare < 1) {
            finePartita()
        }

    }
    
    function buttaSu() {
        noStandby()
        document.querySelectorAll('.muro').forEach(el => el.classList.remove('winner'))

        const tuttiMattoni = document.querySelectorAll('#page' + players + ' .mattone')
        Array.from(tuttiMattoni).forEach(el => el.classList.remove('caduto'))
        document.querySelector('.buttons').classList.add('fadeout')
        document.querySelector('.title').classList.add('fadeout')
        document.querySelector('.stop').classList.remove('fadeout')
        document.querySelector('#page2 .muro.player1').classList.remove('fadeout')
        document.querySelectorAll('#page2 .muro').forEach(el => el.classList.remove('winner'))
        document.querySelector('#page1 .muro').classList.remove('fadeout')

        if (players == 1) {
            muro = document.querySelector('#page1 .muro')
        } else {
            muro = document.querySelector('#page2 .muro.player1')
            muro.classList.add('active')
            target = calculateTarget()
            muro.nextElementSibling.textContent = target
            player = 1
        }
        mattoni = muro.querySelectorAll('.mattone')
        mattoniCaduti = muro.querySelectorAll('.mattone.caduto')
        mattoniDaButtare = mattoni.length - mattoniCaduti.length
        mattoniButtati = 0
    }

    function calculateTarget() {
        target = Math.floor(Math.random() * 3) + 1
        if (Math.random() < 0.03) { // 3% di probabilità di buttare giù 10 mattoni, 1/33
            target = 10
            document.querySelector('#audio-siren').play()
        }
        return target
    }

    function finePartita() {
        if (players == 1) {
            document.querySelector('#page1').style.display = 'block'
            document.querySelector('#page1 .muro').style.display = 'none'
            document.querySelector('#page2').style.display = 'none'
            document.querySelector('.title').classList.remove('fadeout')
        } else {
            document.querySelector('#page1').style.display = 'none'
            document.querySelector('#page2').style.display = 'block'
            document.querySelector('#page2 .muro.player' + player).classList.add('winner')
        }
        document.querySelector('.buttons').classList.remove('fadeout')
        document.querySelector('.stop').classList.add('fadeout')
        document.querySelectorAll('.muro').forEach(el => el.classList.remove('active'))
    }

    // Butto giù nel desktop con il tasto spazio
    document.addEventListener('keyup', function(e) {
        if (e.key == ' ') {
            buttaGiu()
            e.preventDefault() // altrimenti il focus è sul bottone di inizio partita e lo clicca
        }
    })
    
    
</script>
     
</body>
</html>